name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Poetry + tools
        run: |
          python -m pip install --upgrade pip pipx
          pipx install poetry
          poetry --version
          poetry install --no-interaction
          poetry run python -V
          poetry run pip install ruff black bandit pip-audit detect-secrets
      - name: Ruff (tests)
        run: |
          poetry run ruff check tests
      - name: Black (check)
        run: |
          poetry run black --check tests
      - name: Detect secrets (baseline)
        run: |
          poetry run detect-secrets-hook --baseline .secrets.baseline $(git ls-files)
      - name: Bandit (security scan)
        run: |
          mkdir -p artifacts/security
          poetry run bandit -q -r production/src -x tests,dev,archive -f json -o artifacts/security/bandit.json || true
      - name: Upload bandit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security
          path: artifacts/security/bandit.json
          retention-days: 14
      - name: pip-audit (dependency vulnerabilities)
        continue-on-error: true
        run: |
          mkdir -p artifacts/security
          poetry run pip-audit -s -q -f json -o artifacts/security/pip-audit.json || true
      - name: Upload pip-audit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit
          path: artifacts/security/pip-audit.json
          retention-days: 14
      - name: Security summary
        if: always()
        run: |
          python - << 'PY'
          import json, os
          summary = os.environ.get('GITHUB_STEP_SUMMARY')
          def append(line):
              if summary:
                  with open(summary, 'a') as f:
                      f.write(str(line)+'\n')
          def count_bandit(p):
              try:
                  with open(p) as f:
                      data = json.load(f)
                  results = data.get('results', [])
                  sev = {}
                  for r in results:
                      s = str(r.get('issue_severity', 'LOW')).upper()
                      sev[s] = sev.get(s, 0) + 1
                  return len(results), sev
              except Exception:
                  return 0, {}
          def count_pip(p):
              try:
                  with open(p) as f:
                      data = json.load(f)
                  if isinstance(data, dict) and 'dependencies' in data:
                      return sum(len(d.get('vulns', [])) for d in data['dependencies'])
                  elif isinstance(data, list):
                      return len(data)
                  return 0
              except Exception:
                  return 0
          b_total, b_sev = count_bandit('artifacts/security/bandit.json')
          p_total = count_pip('artifacts/security/pip-audit.json')
          append('## Security Summary')
          append(f'- Bandit findings: {b_total} (by severity: {b_sev})')
          append(f'- pip-audit vulnerabilities: {p_total}')
          PY
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies (Poetry)
        run: |
          python -m pip install --upgrade pip pipx
          pipx install poetry
          poetry install --no-interaction
      - name: Run tests
        env:
          PYTHONPATH: production/src:.
        run: |
          poetry run pytest -q

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies (Poetry)
        run: |
          python -m pip install --upgrade pip pipx
          pipx install poetry
          poetry install --no-interaction
          poetry run pip install bandit pip-audit
      - name: Bandit (fail on high severity)
        run: |
          mkdir -p artifacts/security
          poetry run bandit -r production/src -x tests,dev,archive -ll -f json -o artifacts/security/bandit.json
      - name: Upload bandit artifacts (security job)
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security
          path: artifacts/security/bandit.json
          retention-days: 14
      - name: pip-audit (fail on vulnerabilities)
        run: |
          mkdir -p artifacts/security
          poetry run pip-audit -s -f json -o artifacts/security/pip-audit.json || true
      - name: Upload pip-audit artifacts (security job)
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit
          path: artifacts/security/pip-audit.json
          retention-days: 14
