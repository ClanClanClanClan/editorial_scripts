name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Poetry + tools
        run: |
          python -m pip install --upgrade pip pipx
          pipx install poetry
          poetry --version
          poetry install --no-interaction
          poetry run python -V
          # install tooling inside poetry env for consistent versions
          poetry run pip install ruff black mypy bandit pip-audit detect-secrets
      - name: Ruff (src, tests)
        run: |
          poetry run ruff check src tests
      - name: Black (check)
        run: |
          poetry run black --check src tests
      - name: Mypy (API + infra core)
        run: |
          poetry run mypy --follow-imports=skip src/ecc/interfaces src/ecc/infrastructure/database/connection.py src/ecc/infrastructure/tasks/celery_app.py
      - name: Detect secrets (baseline)
        run: |
          poetry run detect-secrets-hook --baseline .secrets.baseline $(git ls-files)
  - name: Bandit (security scan)
        run: |
          mkdir -p artifacts/security
          poetry run bandit -q -r src -x tests,dev,archive,production -f json -o artifacts/security/bandit.json || true
      - name: Upload bandit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security
          path: artifacts/security/bandit.json
          retention-days: 14
  - name: pip-audit (dependency vulnerabilities)
        continue-on-error: true
        run: |
          mkdir -p artifacts/security
          poetry run pip-audit -s -q -f json -o artifacts/security/pip-audit.json || true
      - name: Upload pip-audit artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit
          path: artifacts/security/pip-audit.json
          retention-days: 14
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies (Poetry)
        run: |
          python -m pip install --upgrade pip pipx
          pipx install poetry
          poetry install --no-interaction
      - name: Run tests
        env:
          PYTHONPATH: .
          ECC_GMAIL_2FA_CODE: "123456"
        run: |
          poetry run pytest -q

  strict:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies (Poetry)
        run: |
          python -m pip install --upgrade pip pipx
          pipx install poetry
          poetry install --no-interaction
      - name: Run tests (strict)
        env:
          PYTHONPATH: .
          ECC_GMAIL_2FA_CODE: "123456"
          ECC_REAL_DEPS: "1"
        run: |
          poetry run pytest -q
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies (Poetry)
        run: |
          python -m pip install --upgrade pip pipx
          pipx install poetry
          poetry install --no-interaction
          # Ensure tools are present in env
          poetry run pip install bandit pip-audit
      - name: Bandit (fail on high severity; allowlist supported)
        run: |
          mkdir -p artifacts/security
          SKIPS=$(grep -v '^#' .security/bandit-allowlist.txt 2>/dev/null | tr '\n' ',' | sed 's/,$//')
          if [ -n "$SKIPS" ]; then
            poetry run bandit -r src -x tests,dev,archive,production -ll -s "$SKIPS" -f json -o artifacts/security/bandit.json
          else
            poetry run bandit -r src -x tests,dev,archive,production -ll -f json -o artifacts/security/bandit.json
          fi
      - name: Upload bandit artifacts (security job)
        uses: actions/upload-artifact@v4
        with:
          name: bandit-security
          path: artifacts/security/bandit.json
          retention-days: 14
      - name: pip-audit (fail on vulnerabilities; allowlist supported)
        run: |
          mkdir -p artifacts/security
          IGN=$(grep -v '^#' .security/pip-audit-allowlist.txt 2>/dev/null | xargs -I{} printf -- '--ignore-vuln %s ' '{}')
          poetry run pip-audit -s $IGN -f json -o artifacts/security/pip-audit.json
      - name: Upload pip-audit artifacts (security job)
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit
          path: artifacts/security/pip-audit.json
          retention-days: 14
